<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AskCarBuddy ‚Äî Car Buying Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a; --card: #141414; --card2: #1a1a1a; --border: #2a2a2a;
  --text: #e5e5e5; --text2: #999; --accent: #22c55e; --accent2: #16a34a;
  --warn: #f59e0b; --danger: #ef4444; --blue: #3b82f6; --purple: #a855f7;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

.container { max-width:800px; margin:0 auto; padding:20px; }

/* Header */
.header { text-align:center; padding:60px 20px 40px; }
.logo { font-size:2.5rem; font-weight:800; }
.logo span { color:var(--accent); }
.tagline { color:var(--text2); margin-top:8px; font-size:1.1rem; }

/* Input Section */
.input-section { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:32px; margin-bottom:32px; }
.input-label { font-weight:600; margin-bottom:12px; font-size:1rem; }
.url-input { width:100%; padding:16px 20px; background:var(--bg); border:2px solid var(--border); border-radius:12px;
  color:var(--text); font-size:1rem; font-family:inherit; outline:none; transition:border .2s; }
.url-input:focus { border-color:var(--accent); }
.url-input::placeholder { color:#555; }
.analyze-btn { width:100%; padding:16px; margin-top:16px; background:var(--accent); color:#000; font-weight:700;
  font-size:1.1rem; border:none; border-radius:12px; cursor:pointer; transition:all .2s; font-family:inherit; }
.analyze-btn:hover { background:var(--accent2); transform:translateY(-1px); }
.analyze-btn:disabled { background:#333; color:#666; cursor:not-allowed; transform:none; }

/* Loading */
.loading { text-align:center; padding:60px 20px; display:none; }
.spinner { width:48px; height:48px; border:4px solid var(--border); border-top-color:var(--accent);
  border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { color:var(--text2); font-size:1rem; }
.loading-sub { color:#555; font-size:0.85rem; margin-top:8px; }

/* Error */
.error { background:#1a0a0a; border:1px solid #3a1a1a; border-radius:12px; padding:20px; margin:20px 0;
  color:var(--danger); display:none; }

/* Report */
.report { display:none; animation:fadeIn .5s; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }

/* Score banner */
.score-banner { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:32px;
  text-align:center; margin-bottom:24px; position:relative; overflow:hidden; }
.score-number { font-size:4rem; font-weight:800; line-height:1; }
.score-label { font-size:1.3rem; font-weight:600; margin-top:8px; }
.score-liner { color:var(--text2); margin-top:8px; font-size:1rem; }
.vehicle-title { font-size:1.5rem; font-weight:700; margin-bottom:16px; }
.vehicle-meta { color:var(--text2); font-size:0.9rem; }

/* Cards */
.card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; margin-bottom:16px; }
.card-title { font-size:1.1rem; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
.card-title .icon { font-size:1.3rem; }

/* At a glance */
.glance-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.glance-item { background:var(--card2); border-radius:12px; padding:16px; }
.glance-label { font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text2); margin-bottom:6px; }
.glance-value { font-size:0.95rem; font-weight:500; }

/* Quirks */
.quirk { background:var(--card2); border-radius:12px; padding:16px; margin-bottom:10px; }
.quirk-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.quirk-name { font-weight:600; }
.severity { padding:3px 10px; border-radius:20px; font-size:0.75rem; font-weight:600; text-transform:uppercase; }
.severity-minor_quirk, .severity-minor { background:#1a2e1a; color:#4ade80; }
.severity-worth_checking, .severity-moderate { background:#2e2a1a; color:var(--warn); }
.severity-important, .severity-major { background:#2e1a1a; color:#f87171; }
.severity-serious, .severity-critical { background:#3a0a0a; color:#ef4444; }
.quirk-context { color:var(--text2); font-size:0.9rem; margin-bottom:6px; }
.quirk-action { color:var(--accent); font-size:0.9rem; font-weight:500; }

/* Maintenance */
.maint-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px;
  background:var(--card2); border-radius:10px; margin-bottom:8px; }
.maint-service { font-weight:500; }
.maint-cost { color:var(--text2); font-size:0.9rem; }
.urgency { padding:2px 8px; border-radius:8px; font-size:0.7rem; font-weight:600; text-transform:uppercase; }
.urgency-due_now { background:#3a0a0a; color:#ef4444; }
.urgency-soon { background:#2e2a1a; color:var(--warn); }
.urgency-within_6_months, .urgency-within_a_year { background:#1a2e1a; color:#4ade80; }

/* Game plan */
.plan-step { display:flex; gap:12px; margin-bottom:16px; }
.step-num { width:28px; height:28px; background:var(--accent); color:#000; border-radius:50%;
  display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem; flex-shrink:0; }
.step-content { flex:1; }
.step-question { font-weight:600; margin-bottom:4px; }
.step-why { color:var(--text2); font-size:0.85rem; margin-bottom:4px; }
.step-signals { font-size:0.85rem; }
.good-sign { color:var(--accent); }
.heads-up { color:var(--warn); }

/* OTD box */
.otd-box { background:var(--card2); border-radius:12px; padding:20px; text-align:center; margin:16px 0; }
.otd-price { font-size:2rem; font-weight:800; color:var(--accent); }
.otd-label { color:var(--text2); font-size:0.85rem; margin-top:4px; }

/* Cost grid */
.cost-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.cost-item { background:var(--card2); border-radius:10px; padding:14px; text-align:center; }
.cost-amount { font-size:1.1rem; font-weight:700; }
.cost-label { font-size:0.75rem; color:var(--text2); margin-top:4px; }

/* Pro tips */
.pro-tip { background:var(--card2); border-left:3px solid var(--accent); border-radius:0 10px 10px 0;
  padding:12px 16px; margin-bottom:8px; font-size:0.95rem; }

/* Tags / pills */
.tag { display:inline-block; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; margin:2px; }

/* Lists */
.check-list { list-style:none; }
.check-list li { padding:8px 0; padding-left:24px; position:relative; }
.check-list li::before { content:"‚úì"; position:absolute; left:0; color:var(--accent); font-weight:700; }

.fee-list { list-style:none; }
.fee-list li { padding:6px 0; color:var(--text2); font-size:0.9rem; }
.fee-list li.question { color:var(--warn); }

/* Responsive */
@media(max-width:600px) {
  .glance-grid, .cost-grid { grid-template-columns:1fr; }
  .score-number { font-size:3rem; }
  .container { padding:12px; }
  .header { padding:40px 12px 24px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">Ask<span>Car</span>Buddy</div>
    <div class="tagline">Paste any car listing. Get the intelligence you need.</div>
  </div>

  <div class="input-section">
    <div class="input-label">Paste a car listing URL</div>
    <input type="url" class="url-input" id="urlInput" placeholder="https://www.dealer.com/used/2017-toyota-prius..." autocomplete="off">
    <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">Analyze This Car</button>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing your listing...</div>
    <div class="loading-sub">Scraping listing ¬∑ Checking market comps ¬∑ Running NHTSA ¬∑ Generating brief</div>
  </div>

  <div class="error" id="error"></div>

  <div class="report" id="report"></div>
</div>

<script>
const API_BASE = window.location.origin;

async function analyze() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;

  const btn = document.getElementById('analyzeBtn');
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const report = document.getElementById('report');

  btn.disabled = true; btn.textContent = 'Analyzing...';
  loading.style.display = 'block';
  error.style.display = 'none';
  report.style.display = 'none';

  try {
    const resp = await fetch(API_BASE + '/api/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url: url})
    });
    const data = await resp.json();

    if (data.error) {
      error.textContent = data.error;
      error.style.display = 'block';
    } else {
      report.innerHTML = renderReport(data);
      report.style.display = 'block';
    }
  } catch(e) {
    error.textContent = 'Connection failed. Is the server running?';
    error.style.display = 'block';
  }

  loading.style.display = 'none';
  btn.disabled = false; btn.textContent = 'Analyze This Car';
}

// Enter key
document.getElementById('urlInput').addEventListener('keydown', e => { if(e.key==='Enter') analyze(); });

function scoreColor(s) {
  if(s>=8) return '#22c55e'; if(s>=6) return '#f59e0b'; if(s>=4) return '#f97316'; return '#ef4444';
}

function renderReport(data) {
  const v = data.vehicle || {};
  const a = data.analysis || {};
  const bs = a.buy_score || {};
  const ag = a.at_a_glance || {};
  const mi = a.market_intel || {};
  const wtk = a.what_to_know || {};
  const gp = a.your_game_plan || {};
  const co = a.cost_to_own || {};
  const tips = a.pro_tips || [];

  let h = '';

  // Score Banner
  h += `<div class="score-banner">
    <div class="vehicle-title">${v.year||''} ${v.make||''} ${v.model||''} ${v.trim||''}</div>
    <div class="vehicle-meta">${v.price?'$'+v.price.toLocaleString():''} ¬∑ ${v.mileage?v.mileage.toLocaleString()+' mi':''} ¬∑ ${v.color||''}</div>
    <div style="margin-top:20px">
      <div class="score-number" style="color:${scoreColor(bs.score||5)}">${bs.score||'?'}/10</div>
      <div class="score-label">${bs.label||''}</div>
      <div class="score-liner">${bs.one_liner||''}</div>
    </div>
  </div>`;

  // At a Glance
  if(ag.best_thing || ag.know_before_you_go) {
    h += `<div class="card"><div class="card-title"><span class="icon">‚ö°</span> At a Glance</div>
      <div class="glance-grid">
        <div class="glance-item"><div class="glance-label">Best Thing</div><div class="glance-value">${ag.best_thing||''}</div></div>
        <div class="glance-item"><div class="glance-label">Know Before You Go</div><div class="glance-value">${ag.know_before_you_go||''}</div></div>
      </div></div>`;
  }

  // Market Intel
  if(mi.summary) {
    const posColors = {below_market:'#22c55e',competitive:'#22c55e',market_price:'#f59e0b',above_market:'#f97316'};
    const posLabels = {below_market:'Below Market',competitive:'Competitive',market_price:'Market Price',above_market:'Above Market'};
    h += `<div class="card"><div class="card-title"><span class="icon">üìä</span> Market Intel</div>
      <p style="margin-bottom:12px">${mi.summary}</p>
      <span class="tag" style="background:${posColors[mi.price_position]||'#555'}20;color:${posColors[mi.price_position]||'#999'}">${posLabels[mi.price_position]||mi.price_position||''}</span>
      ${(mi.value_factors||[]).map(f=>`<p style="color:var(--text2);font-size:0.9rem;margin-top:8px">‚Ä¢ ${f}</p>`).join('')}
    </div>`;
  }

  // What to Know
  if(wtk.generation_overview || (wtk.known_quirks&&wtk.known_quirks.length)) {
    h += `<div class="card"><div class="card-title"><span class="icon">üîç</span> What to Know About This Car</div>`;
    if(wtk.generation_overview) h += `<p style="margin-bottom:16px;color:var(--text2)">${wtk.generation_overview}</p>`;
    (wtk.known_quirks||[]).forEach(q => {
      h += `<div class="quirk">
        <div class="quirk-header"><span class="quirk-name">${q.item||''}</span><span class="severity severity-${(q.severity||'').replace(/ /g,'_')}">${q.severity||''}</span></div>
        <div class="quirk-context">${q.context||''}</div>
        <div class="quirk-action">‚Üí ${q.what_to_do||''}</div>
      </div>`;
    });
    h += `</div>`;
  }

  // Maintenance Upcoming
  if(wtk.maintenance_upcoming && wtk.maintenance_upcoming.length) {
    h += `<div class="card"><div class="card-title"><span class="icon">üîß</span> Upcoming Maintenance</div>`;
    wtk.maintenance_upcoming.forEach(m => {
      h += `<div class="maint-item">
        <div><span class="maint-service">${m.service||''}</span><br><span class="maint-cost">${m.typical_cost||''}</span></div>
        <span class="urgency urgency-${(m.urgency||'').replace(/ /g,'_')}">${(m.urgency||'').replace(/_/g,' ')}</span>
      </div>`;
    });
    h += `</div>`;
  }

  // Your Game Plan
  if(gp.before_you_visit || gp.at_the_dealer || gp.on_the_test_drive) {
    h += `<div class="card"><div class="card-title"><span class="icon">üéØ</span> Your Game Plan</div>`;

    if(gp.before_you_visit && gp.before_you_visit.length) {
      h += `<h4 style="margin-bottom:10px;color:var(--accent)">Before You Visit</h4><ul class="check-list">`;
      gp.before_you_visit.forEach(s => { h += `<li>${s}</li>`; });
      h += `</ul><div style="margin-bottom:20px"></div>`;
    }

    if(gp.at_the_dealer && gp.at_the_dealer.length) {
      h += `<h4 style="margin-bottom:12px;color:var(--accent)">Questions to Ask</h4>`;
      gp.at_the_dealer.forEach((q,i) => {
        h += `<div class="plan-step">
          <div class="step-num">${i+1}</div>
          <div class="step-content">
            <div class="step-question">"${q.ask||''}"</div>
            <div class="step-why">${q.why||''}</div>
            <div class="step-signals">
              <span class="good-sign">‚úì ${q.good_sign||''}</span><br>
              <span class="heads-up">‚ö† ${q.heads_up||''}</span>
            </div>
          </div>
        </div>`;
      });
    }

    if(gp.on_the_test_drive && gp.on_the_test_drive.length) {
      h += `<h4 style="margin:16px 0 10px;color:var(--accent)">On the Test Drive</h4><ul class="check-list">`;
      gp.on_the_test_drive.forEach(s => { h += `<li>${s}</li>`; });
      h += `</ul>`;
    }

    // OTD
    if(gp.at_the_desk) {
      const desk = gp.at_the_desk;
      h += `<div class="otd-box">
        <div class="otd-label">Estimated Out-the-Door</div>
        <div class="otd-price">${desk.expected_otd||'‚Äî'}</div>
      </div>`;
      if(desk.fees_to_expect && desk.fees_to_expect.length) {
        h += `<p style="font-weight:600;margin:12px 0 6px">Fees to Expect</p><ul class="fee-list">`;
        desk.fees_to_expect.forEach(f => { h += `<li>‚Ä¢ ${f}</li>`; });
        h += `</ul>`;
      }
      if(desk.fees_to_question && desk.fees_to_question.length) {
        h += `<p style="font-weight:600;margin:12px 0 6px;color:var(--warn)">Fees to Question</p><ul class="fee-list">`;
        desk.fees_to_question.forEach(f => { h += `<li class="question">‚ö† ${f}</li>`; });
        h += `</ul>`;
      }
      if(desk.financing_tip) {
        h += `<div class="pro-tip" style="margin-top:12px">üí° ${desk.financing_tip}</div>`;
      }
    }
    h += `</div>`;
  }

  // Cost to Own
  if(co.monthly_fuel || co.annual_insurance_range) {
    h += `<div class="card"><div class="card-title"><span class="icon">üí∞</span> Cost to Own</div>
      <div class="cost-grid">
        <div class="cost-item"><div class="cost-amount">${co.monthly_fuel||'‚Äî'}</div><div class="cost-label">Monthly Fuel</div></div>
        <div class="cost-item"><div class="cost-amount">${co.annual_insurance_range||'‚Äî'}</div><div class="cost-label">Annual Insurance</div></div>
        <div class="cost-item"><div class="cost-amount">${co.annual_maintenance||'‚Äî'}</div><div class="cost-label">Annual Maintenance</div></div>
        <div class="cost-item"><div class="cost-amount">${co.total_annual_estimate||'‚Äî'}</div><div class="cost-label">Total Annual Cost</div></div>
      </div>
      ${co.ownership_verdict ? `<p style="text-align:center;color:var(--text2);margin-top:12px;font-size:0.9rem">${co.ownership_verdict}</p>` : ''}
    </div>`;
  }

  // Pro Tips
  if(tips.length) {
    h += `<div class="card"><div class="card-title"><span class="icon">‚≠ê</span> Pro Tips</div>`;
    tips.forEach(t => { h += `<div class="pro-tip">${t}</div>`; });
    h += `</div>`;
  }

  // Footer
  h += `<div style="text-align:center;padding:32px;color:#444;font-size:0.8rem">
    AskCarBuddy ¬∑ Report #${data.report_id||'‚Äî'} ¬∑ Generated ${new Date(data.generated_at).toLocaleDateString()}<br>
    Not financial advice. Always get a pre-purchase inspection.
  </div>`;

  return h;
}
</script>
</body>
</html>